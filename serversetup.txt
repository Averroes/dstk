Start with AMI # ami-cef405a7

sudo aptitude update
sudo aptitude safe-upgrade
sudo aptitude full-upgrade
sudo aptitude install build-essential
sudo aptitude install apache2 apache2.2-common apache2-mpm-prefork apache2-utils libexpat1 ssl-cert
sudo aptitude install postgresql

sudo nano /etc/postgresql/8.4/main/pg_hba.conf
<change ident and md5 to trust>
sudo /etc/init.d/postgresql restart
createdb -U postgres geodict
sudo aptitude install libpq-dev

sudo aptitude install ruby1.8-dev ruby1.8 ri1.8 rdoc1.8 irb1.8 libreadline-ruby1.8 libruby1.8 libopenssl-ruby sqlite3 libsqlite3-ruby1.8
sudo ln -s /usr/bin/ruby1.8 /usr/bin/ruby
sudo ln -s /usr/bin/ri1.8 /usr/bin/ri
sudo ln -s /usr/bin/rdoc1.8 /usr/bin/rdoc
sudo ln -s /usr/bin/irb1.8 /usr/bin/irb
mkdir ~/sources
cd ~/sources
wget http://rubyforge.org/frs/download.php/74388/rubygems-1.6.1.tgz
tar xzvf rubygems-1.6.1.tgz
cd rubygems-1.6.1/
sudo ruby setup.rb
sudo ln -s /usr/bin/gem1.8 /usr/bin/gem
sudo gem update --system
sudo gem update
sudo gem install daemons

sudo nano /etc/apache2/sites-enabled/geodictapi.com
 <VirtualHost *:80>
 ServerName geodictapi.com
 ProxyPass / http://geodictapi.com:4567/
 </VirtualHost>
sudo cp /etc/apache2/mods-available/proxy.conf /etc/apache2/mods-enabled/proxy.conf
sudo cp /etc/apache2/mods-available/proxy.load /etc/apache2/mods-enabled/proxy.load
sudo cp /etc/apache2/mods-available/proxy_http.load /etc/apache2/mods-enabled/proxy_http.load
sudo apache2ctl graceful

cd ~/sources
sudo aptitude install git

git clone git://github.com/petewarden/geodictapi.git
git clone git://github.com/petewarden/geodictdata.git
cd geodictapi
sudo gem install bundler
sudo bundle install
./populate_database.rb

sudo nano /etc/init.d/geodict
#!/bin/bash
#
# See http://www.kalzumeus.com/2010/01/15/deploying-sinatra-on-ubuntu-in-which-i-employ-a-secretary/

sudo -u www-data ruby /home/ubuntu/sources/geodictapi/geodict_server.rb $1
RETVAL=$?

exit $RETVAL

sudo chmod +x /etc/init.d/geodict
sudo update-rc.d geodict defaults

sudo mkdir /opt/pids/
sudo mkdir /opt/pids/sinatra
sudo chown www-data /opt/pids/sinatra
sudo /etc/init.d/geodict start
